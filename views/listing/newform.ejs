<% layout("/layouts/boilerplate") -%>
<div class="row">
    <div class="col-8 offset-2">
        <br>
        <h3>Create a new listing</h3>
        
        <form method="post" action="/listings" novalidate class="needs-validation">
            <!-- Title -->
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input id="title" name="title" placeholder="Enter title" type="text" class="form-control">
                <div class="valid-feedback">Title look good !!</div>
            </div>

            <!-- Description -->
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <input id="description" name="description" placeholder="Enter description" class="form-control" required>
            </div>

            <!-- Image -->
            <div class="mb-3">
                <label for="image" class="form-label">Image (URL)</label>
                <input id="image" name="image" placeholder="Image URL (optional)" type="url" class="form-control">
            </div>

            <!-- Price, Location, Country -->
            <div class="row">
                <div class="mb-3 col-md-4">
                    <label for="price" class="form-label">Price</label>
                    <input id="price" name="price" placeholder="Enter price" class="form-control" required>
                    <div class="invalid-feedback">Please enter a valid Price</div>
                </div>

                <div class="mb-3 col-md-8">
                    <label for="location" class="form-label">Location</label>
                    <input id="location" name="location" placeholder="Enter location" type="text" class="form-control" required>
                     <div class="invalid-feedback">location should be valid </div>
                </div>
                <input type="hidden" id="latitude" name="latitude" />
                <input type="hidden" id="longitude" name="longitude" />

                <div class="mb-3 col-md-12">
                    <label for="country" class="form-label">Country</label>
                    <input id="country" name="country" placeholder="Enter country" type="text" class="form-control" required>
                     <div class="invalid-feedback">Country should be valid </div>
                </div>
            </div>

            <button type="submit" class="btn btn-dark add-btn">Add listing</button>
        </form>
    </div>
</div>

<% if (MAP_TOKEN) { %>
  <script>
    (function setupAutocomplete() {
      function attachAutocomplete() {
        var input = document.getElementById('location');
        if (!input) return;
        var latInput = document.getElementById('latitude');
        var lngInput = document.getElementById('longitude');
        try {
          if (!window.google || !google.maps || !google.maps.places) {
            // Retry a few times if Google API not ready
            attachAutocomplete._attempts = (attachAutocomplete._attempts || 0) + 1;
            if (attachAutocomplete._attempts < 6) {
              setTimeout(attachAutocomplete, 500);
            } else {
              console.warn("Google Maps Places API not available; location autocomplete disabled.");
            }
            return;
          }
          var autocomplete = new google.maps.places.Autocomplete(input, { fields: ["formatted_address", "geometry", "name"] });
          autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            if (!place || !place.geometry) return;
            input.value = place.formatted_address || input.value;
            latInput.value = place.geometry.location.lat();
            lngInput.value = place.geometry.location.lng();
          });
          console.info("Places autocomplete initialized for #location");
        } catch (e) {
          console.error("Autocomplete setup error:", e);
        }
      }
      // Expose callback for Google script and attempt attach in case callback isn't invoked
      window.initAutocomplete = attachAutocomplete;
      setTimeout(attachAutocomplete, 600);
    })();
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= MAP_TOKEN %>&libraries=places&callback=initAutocomplete"></script>
<% } %>
