<% layout("/layouts/boilerplate") -%>

<div class="row mt-3">

  <!-- ================= TITLE SECTION ================= -->
  <div class="col-8 offset-2 text-center">
    <h3><b><%= partIdlisting.title %></b></h3>
  </div>


  <!-- ================= LISTING CARD SECTION ================= -->
  <div class="col-8 offset-2 d-flex justify-content-center mt-3">
    <div class="card listing-card" style="width: 30rem;">

      <!-- Listing Image -->
      <img 
        src="<%= partIdlisting.image.url %>" 
        class="card-img-top show-image" 
        alt="listing_image"
      >

      <!-- Listing Details -->
      <div class="card-body">
        <p class="card-text">
          <%= partIdlisting.description %> <br>
          â‚¹ <%= partIdlisting.price.toLocaleString("en-IN") %> <br>
          <%= partIdlisting.location %> <br>
          <%= partIdlisting.country %>
        </p>

        <% if (MAP_TOKEN) { %>
          <div id="map" style="height:300px; width:100%; border-radius:8px; margin-top:1rem;"></div>
          <script>console.log("Listing coords:", { lat: <%= partIdlisting.latitude ? partIdlisting.latitude : 'null' %>, lng: <%= partIdlisting.longitude ? partIdlisting.longitude : 'null' %> });</script>

          <script>
            function initMap() {
              // If coordinates are stored, use them directly
              <% if (partIdlisting.latitude && partIdlisting.longitude) { %>
                var coords = { lat: <%= partIdlisting.latitude %>, lng: <%= partIdlisting.longitude %> };
                var map = new google.maps.Map(document.getElementById("map"), {
                  zoom: 12,
                  center: coords
                });
                var marker = new google.maps.Marker({ map: map, position: coords });
              <% } else { %>
                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: "<%= partIdlisting.location %>" }, function(results, status) {
                  if (status === "OK" && results[0]) {
                    var loc = results[0].geometry.location;
                    var map = new google.maps.Map(document.getElementById("map"), {
                      zoom: 12,
                      center: loc
                    });
                    var marker = new google.maps.Marker({
                      map: map,
                      position: loc
                    });
                  } else {
                    document.getElementById("map").innerText = "Map unavailable for this location.";
                  }
                });
              <% } %>
            }
          </script>
          <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= MAP_TOKEN %>&callback=initMap"></script>
        <% } %>
      </div>
    </div>
  </div>


  <!-- ================= EDIT / DELETE LISTING BUTTONS ================= -->
     <!-- only show if current user is the owner of listing -->
  <% if (currentUser && String(currentUser._id) === String((partIdlisting.owner && (partIdlisting.owner._id || partIdlisting.owner)))) { %>
    <div class="col-8 offset-2 d-flex justify-content-center gap-3 mt-4">

      <!-- Edit Listing Button -->
      <a 
        href="/listings/<%= partIdlisting._id %>/edit" 
        class="btn btn-dark btn-edit"
      >
        Edit
      </a>

      <!-- Delete Listing Form -->
      <!-- method-override is used to send DELETE request -->
      <form 
        method="POST" 
        action="/listings/<%= partIdlisting._id %>?_method=DELETE"
      >
        <button class="btn btn-dark">Delete</button>
      </form>

    </div>
  <% } %>


  <!-- ================= REVIEW FORM SECTION ================= -->

  <% if(currentUser){ %>
    <div class="col-8 offset-2 mt-5">

      <h4>Leave a Review</h4>

      <!-- Review Create Form -->
      <!-- POST /listings/:id/reviews -->
      <form 
        class="mb-3 needs-validation"
        action="/listings/<%= partIdlisting._id %>/reviews"
        method="POST"
        novalidate
      >

        <!-- Rating Input -->
        <div class="mb-3 mt-3">
          <label class="form-label">Rating</label>
          <fieldset class="starability-slot">
            <legend>Rating:</legend>
            <input type="radio" id="first-rate1" name="review[rating]" value="1" required />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" required />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" required />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" required />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input type="radio" id="first-rate5" name="review[rating]" value="5" checked required />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>
        </div>

        <!-- Comment Input -->
        <div class="mb-3 mt-3">
          <label for="comment" class="form-label">Comments</label>
          <textarea 
            name="review[comment]"
            id="comment"
            cols="30"
            rows="5"
            class="form-control"
            required
          ></textarea>

          <!-- Bootstrap validation message -->
          <div class="invalid-feedback">
            Please add some comment for review
          </div>
        </div>

        <button class="btn btn-dark">Submit</button>
      </form>
    </div>
  <% } %>

  <hr>

    


    <!-- ================= ALL REVIEWS SECTION ================= -->
    <p><b>All reviews</b></p>

    <div class="row">

      <!-- Check if reviews exist -->
      <% if (partIdlisting.reviews && partIdlisting.reviews.length) { %>

        <!-- Loop through all reviews -->
        <% for (let review of partIdlisting.reviews) { %>

          <div class="card col-5 ms-3 mb-3">
            <div class="card-body">
              <h5 class="card-title"></h5>
              <p class="card-text"><%= review.comment %></p>
              <p class="card-text"><%= review.rating %> stars</p>
            </div>

            <!-- Delete Review Form -->
            <!-- DELETE /listings/:id/reviews/:reviewId -->
            <form 
              class="mb-3"
              method="POST"
              action="/listings/<%= partIdlisting._id %>/reviews/<%= review._id %>?_method=DELETE"
            >
              <button class="btn btn-sm btn-dark">Delete</button>
            </form>
          </div>

        <% } %>

      <% } else { %>

        <!-- Message when no reviews exist -->
        <p>No reviews yet.</p>

      <% } %>

    </div>
  </div>
</div>

<!-- Custom JS file -->
<script src="/js/script.js"></script>
